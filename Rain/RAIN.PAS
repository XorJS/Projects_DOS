PROGRAM RAIN;

VAR PALETTE:ARRAY[0..767] OF BYTE;

PROCEDURE INIT_MODE_X;
ASSEMBLER;
ASM
 MOV AX,0013H
 INT 10H
 MOV DX,03C4H
 XOR AH,AH
 MOV AL,04
 OUT DX,AL
 MOV DX,03C5H
 IN AL,DX
 XOR AL,00001000B
 OUT DX,AL
 MOV DX,03C4H
 MOV AL,04H
 OUT DX,AL
 MOV DX,03C5H
 IN AL,DX
 AND AL,11110111B
 OR AL,04h
 OUT DX,AL
 MOV DX,03D4H
 MOV AL,14H
 OUT DX,AL
 MOV DX,03D5H
 IN AL,DX
 AND AL,10111111B
 OUT DX,AL
 MOV DX,03D4H
 MOV AL,17H
 OUT DX,AL
 MOV DX,03D5H
 IN AL,DX
 OR AL,01000000B
 OUT DX,AL
 MOV DX,03C4H
 MOV AH,1111B
 MOV AL,02H
 OUT DX,AX
 MOV AX,0A000H
 MOV ES,AX
 XOR SI,SI
 XOR DI,DI
 XOR AX,AX
 CLD
 MOV CX,0FFFFH/4
 DB 66H
 REP STOSW
END;

PROCEDURE SHADE_PAL;
VAR COMPT:BYTE;
BEGIN
 FOR COMPT:=000 TO 127 DO
 BEGIN
   PALETTE[3*compt+2]:=COMPT SHR 1;
   PALETTE[3*(compt+128)+2]:= (127-COMPT) SHR 1;
   PALETTE[3*compt+1]:=COMPT SHR 2;
   PALETTE[3*(compt+128)+1]:= (127-COMPT) SHR 2;
   PALETTE[3*compt+0]:=COMPT SHR 3;
   PALETTE[3*(compt+128)+0]:= (127-COMPT) SHR 3;
 END;
 ASM
  PUSH SI
  MOV SI,OFFSET PALETTE
  MOV DX,03C8H
  MOV CX,3*256
  OUT DX,AL
  INC DX
  REP OUTSB
  POP SI
 END;
END;

PROCEDURE PUT_SHADE(X,Y:WORD);
ASSEMBLER;
LABEL HAUTEUR;
ASM
 MOV AX,0A000H
 MOV ES,AX
 IMUL AX,Y,80
 ADD AX,X
 MOV DI,AX
 MOV CX,4
 XOR AH,AH
 MOV AL,ES:[DI]
 INC AL
HAUTEUR:
 MOV ES:[DI],AL
 ADD DI,80
 DEC CX
 JNE HAUTEUR
END;

PROCEDURE CLEAR_A000;
ASSEMBLER;
ASM
 MOV AX,0A000H
 MOV ES,AX
 XOR SI,SI
 XOR DI,DI
 XOR AX,AX
 CLD
 MOV CX,0FFFFH
 REP STOSB
END;

PROCEDURE WAIT_RETRACE;
ASSEMBLER;
ASM
  MOV DX,03DAh
@WAIT1:
  IN AL,DX
  TEST AL,11111111b
  JNZ @WAIT1
@WAIT2:
  IN AL,DX
  TEST AL,08h
  JZ @WAIT2
END;

VAR KEYB:BYTE;
    X,Y:INTEGER;
BEGIN
 INIT_MODE_X;
 CLEAR_A000;
 SHADE_PAL;
 WAIT_RETRACE;
 REPEAT
  X:=RANDOM(80);
  Y:=RANDOM(196);
  PUT_SHADE(X,Y);
  ASM
   IN AL,60H
   MOV BYTE PTR KEYB,AL
   XOR AX,AX
  END;
 UNTIL (KEYB = 1);
 ASM
   MOV AX,03H;
   INT 10H;
 END;
END.
